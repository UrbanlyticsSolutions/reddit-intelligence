name: Scheduled Analysis & Pages Update

on:
  schedule:
    # Trading Hours (Mon-Fri): 14:30 - 21:00 UTC
    - cron: '30 14 * * 1-5'
    - cron: '*/30 15-20 * * 1-5'
    - cron: '0 21 * * 1-5'
    # Off Hours (Mon-Fri): Every 2 hours
    - cron: '0 23,1,3,5,7,9,11,13 * * 1-5'
    # Weekends (Sat-Sun): Every 2 hours
    - cron: '0 1,3,5,7,9,11,13,15,17,19,21,23 * * 0,6'
  workflow_dispatch:

env:
  GCS_BUCKET_NAME: stock-479103-deepseek-results
  ENABLE_SCHEDULED_RELEASES: 'false'  # Set to 'true' to re-enable automation

jobs:
  run-analysis:
    if: ${{ env.ENABLE_SCHEDULED_RELEASES == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for pushing to gh-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Authenticate to Google Cloud
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Execute Cloud Run Job
      - name: Execute Cloud Run Job
        run: |
          gcloud run jobs execute reddit-intelligence-job --region us-central1 --wait

      - name: Prepare GitHub Pages
        run: |
          set -euo pipefail
          rm -rf site
          mkdir -p site

          # Copy static frontend bundle into publish directory
          cp frontend/index.html site/
          cp frontend/app.js site/
          cp frontend/styles.css site/

          # Pull the freshest DeepSeek payload from Cloud Storage
          if gcloud storage cp "gs://${GCS_BUCKET_NAME}/latest_deepseek_result.json" site/latest.json; then
            echo "Pulled latest_deepseek_result.json from ${GCS_BUCKET_NAME}"
          else
            echo '{"error":"No DeepSeek artifact available yet."}' > site/latest.json
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update market intelligence reports [skip ci]'
